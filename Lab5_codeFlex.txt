/**
 * =================================================================
 * üöÄ DIALOGFLOW ES WEBHOOK - CODE.GS (FLEX MESSAGE VERSION)
 * =================================================================
 * - Cache-only (‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô Sheet ‡πÉ‡∏ô doPost)
 * - ‡∏™‡πà‡∏á Flex Message (LINE) ‡∏ú‡πà‡∏≤‡∏ô Dialogflow
 * - ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ü‡πâ‡∏≤‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•
 * - ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö cache.gs
 */

// ----------------------------------------------------------------
// üîß CONFIGURATION
// ----------------------------------------------------------------

const INTENT_PREFIX = "herb";
const CODE_REGEX = /^[hH]\d+/;

// =================================================================
// üèõÔ∏è CORE CACHE-ONLY WRAPPERS
// =================================================================

function getDataCacheOnly_() {
  const cache = CacheService.getScriptCache();
  const cached = cache.get(CACHE_KEY);

  if (cached) {
    try {
      return JSON.parse(cached);
    } catch (e) {
      Logger.log("Error parsing cache: " + e.message);
      return null;
    }
  }
  return null;
}

function findByIndexCacheOnly_(key, value) {
  if (!value) return null;

  const cacheData = getDataCacheOnly_();
  if (!cacheData) return "CACHE_MISS";

  const indexer = INDEX_KEYS[key];
  if (!indexer || !cacheData.index || !cacheData.index[key]) {
    Logger.log("Index key not found: " + key);
    return null;
  }

  const normalizedValue = indexer(value);
  return cacheData.index[key][normalizedValue] || null;
}

// =================================================================
// üåê WEBHOOK ENTRY POINT
// =================================================================

function doPost(e) {
  Logger.log("--- doPost Start ---");

  try {
    const request = JSON.parse(e.postData.contents);
    const intentName = request.queryResult.intent.displayName;
    Logger.log("Intent: " + intentName);

    if (!intentName.startsWith(INTENT_PREFIX)) {
      return emptyResponse_();
    }

    const query = extractQueryFromContexts_(request.queryResult.outputContexts);
    if (!query) {
      return textResponse_("ü§î ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏∞");
    }

    const searchKey = CODE_REGEX.test(query) ? "code" : "herb";
    const result = findByIndexCacheOnly_(searchKey, query);

    if (result === "CACHE_MISS") {
      return textResponse_("‚è≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 1‚Äì2 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞");
    }

    if (!result) {
      return textResponse_(`üôÅ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${query}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πà‡∏∞`);
    }

    // ‚úÖ FOUND ‚Üí FLEX MESSAGE
    const flex = createFlexHerbMessage_(result);
    return flexResponse_(flex);

  } catch (err) {
    Logger.log("CRITICAL ERROR: " + err + " | " + err.stack);
    return textResponse_("üö® ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á Admin ‡∏Ñ‡πà‡∏∞");
  } finally {
    Logger.log("--- doPost End ---");
  }
}

// =================================================================
// üß∞ CONTEXT & QUERY
// =================================================================

function extractQueryFromContexts_(outputContexts) {
  if (!outputContexts) return null;

  for (let i = 0; i < outputContexts.length; i++) {
    const p = outputContexts[i].parameters;
    if (!p) continue;

    if (p.herb && String(p.herb).trim()) {
      return String(p.herb).trim();
    }
    if (p["herb.original"] && String(p["herb.original"]).trim()) {
      return String(p["herb.original"]).trim();
    }
  }
  return null;
}

// =================================================================
// üé® FLEX MESSAGE BUILDER (PASTEL GREEN-BLUE)
// =================================================================

function createFlexHerbMessage_(item) {
  return {
    type: "flex",
    altText: `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£ ${item.herb}`,
    contents: {
      type: "bubble",
      size: "mega",
      styles: {
        body: {
          backgroundColor: "#E6F7F4"
        }
      },
      body: {
        type: "box",
        layout: "vertical",
        spacing: "md",
        contents: [

          {
            type: "text",
            text: "üåø ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£",
            weight: "bold",
            size: "lg",
            color: "#1B7F7A"
          },

          {
            type: "box",
            layout: "vertical",
            backgroundColor: "#BEEAE3",
            cornerRadius: "12px",
            paddingAll: "12px",
            contents: [
              {
                type: "text",
                text: item.herb,
                weight: "bold",
                size: "xl",
                color: "#065F5B"
              },
              {
                type: "text",
                text: `‡∏£‡∏´‡∏±‡∏™: ${item.code}`,
                size: "sm",
                color: "#3A9188"
              }
            ]
          },

          flexRow_("‚ú® ‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì", item.effect),
          flexRow_("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", item.description),
          flexRow_("üìä ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠", item.loe),
          flexRow_("üìö ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á", item.ref)
        ]
      }
    }
  };
}

function flexRow_(label, value) {
  return {
    type: "box",
    layout: "vertical",
    spacing: "xs",
    contents: [
      {
        type: "text",
        text: label,
        weight: "bold",
        size: "sm",
        color: "#1B7F7A"
      },
      {
        type: "text",
        text: value || "-",
        size: "sm",
        wrap: true,
        color: "#065F5B"
      }
    ]
  };
}

// =================================================================
// üì¶ RESPONSE HELPERS (Dialogflow Compatible)
// =================================================================

function flexResponse_(flexMessage) {
  return ContentService.createTextOutput(JSON.stringify({
    fulfillmentMessages: [
      {
        payload: {
          line: flexMessage
        }
      }
    ]
  })).setMimeType(ContentService.MimeType.JSON);
}

function textResponse_(text) {
  return ContentService.createTextOutput(JSON.stringify({
    fulfillmentText: text,
    fulfillmentMessages: [
      { text: { text: [text] } }
    ]
  })).setMimeType(ContentService.MimeType.JSON);
}

function emptyResponse_() {
  return ContentService.createTextOutput(JSON.stringify({}))
    .setMimeType(ContentService.MimeType.JSON);
}
