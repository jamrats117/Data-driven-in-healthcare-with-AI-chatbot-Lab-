function doPost(e) {
  var log = BetterLog.useSpreadsheet();
  log.info("ğŸ“© Incoming Event: " + JSON.stringify(e));

  var body = JSON.parse(e.postData.contents);
  log.info("ğŸ“¦ Body: " + JSON.stringify(body));

  var event = body.events[0];
  var userId = event.source.userId;
  var replyToken = event.replyToken;
  var userMessage = event.message.text.trim();

  log.info("ğŸ‘¤ User ID: " + JSON.stringify(userId));
  log.info("ğŸ’¬ User Message: " + JSON.stringify(userMessage));

  var cache = CacheService.getUserCache();
  var state = cache.get(userId);

  log.info("ğŸ“Œ Current State: " + JSON.stringify(state));

  // à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸„à¸³à¸™à¸§à¸“ BMI
  if (userMessage === "BMI" || userMessage === "à¸„à¸³à¸™à¸§à¸“ BMI") {
    cache.put(userId, "ASK_WEIGHT", 600);
    replyText(replyToken, "âš–ï¸ à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸‚à¸­à¸‡à¸„à¸¸à¸“ (kg)");
    return;
  }

  // à¸£à¸±à¸šà¸™à¹‰à¸³à¸«à¸™à¸±à¸
  if (state === "ASK_WEIGHT") {
    cache.put(userId + "_weight", userMessage, 600);
    cache.put(userId, "ASK_HEIGHT", 600);

    log.info("âš–ï¸ Weight Saved: " + JSON.stringify(userMessage));
    replyText(replyToken, "ğŸ“ à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸ªà¹ˆà¸§à¸™à¸ªà¸¹à¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“ (à¹€à¸¡à¸•à¸£ à¹€à¸Šà¹ˆà¸™ 1.70)");
    return;
  }

  // à¸£à¸±à¸šà¸ªà¹ˆà¸§à¸™à¸ªà¸¹à¸‡
  if (state === "ASK_HEIGHT") {
    cache.put(userId + "_height", userMessage, 600);
    cache.put(userId, "CONFIRM", 600);

    var weight = cache.get(userId + "_weight");
    var height = userMessage;

    log.info("ğŸ“ Height Saved: " + JSON.stringify(height));

    replyText(
      replyToken,
      "âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡\n\n" +
      "âš–ï¸ à¸™à¹‰à¸³à¸«à¸™à¸±à¸: " + weight + " kg\n" +
      "ğŸ“ à¸ªà¹ˆà¸§à¸™à¸ªà¸¹à¸‡: " + height + " m\n\n" +
      "ğŸ‘‰ à¹ƒà¸Šà¹ˆà¸à¸” 1\nğŸ‘‰ à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸à¸” 2"
    );
    return;
  }

  // à¸¢à¸·à¸™à¸¢à¸±à¸™
  if (state === "CONFIRM") {
    if (userMessage === "1") {
      var weight = parseFloat(cache.get(userId + "_weight"));
      var height = parseFloat(cache.get(userId + "_height"));

      log.info("ğŸ“Š Confirm Weight: " + JSON.stringify(weight));
      log.info("ğŸ“Š Confirm Height: " + JSON.stringify(height));

      var bmi = weight / (height * height);
      var bmiResult = bmi.toFixed(2);

      var interpretation = interpretBMI(bmi);

      replyText(
        replyToken,
        "ğŸ‰ à¸œà¸¥à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“ BMI ğŸ‰\n\n" +
        "ğŸ“Š BMI à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­: *" + bmiResult + "*\n" +
        interpretation
      );

      cache.remove(userId);
      cache.remove(userId + "_weight");
      cache.remove(userId + "_height");

      return;
    }

    if (userMessage === "2") {
      cache.remove(userId);
      replyText(replyToken, "âŒ à¸¢à¸à¹€à¸¥à¸´à¸à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“à¹à¸¥à¹‰à¸§\nà¸à¸´à¸¡à¸à¹Œ *BMI* à¹€à¸à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¹ƒà¸«à¸¡à¹ˆ ğŸ˜Š");
      return;
    }
  }
}

function interpretBMI(bmi) {
  var log = BetterLog.useSpreadsheet();
  log.info("ğŸ§® BMI Value: " + JSON.stringify(bmi));

  if (bmi < 18.5) {
    return "ğŸƒ à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹€à¸à¸“à¸‘à¹Œ *à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸™à¹‰à¸­à¸¢*";
  } else if (bmi < 23) {
    return "ğŸ’ª à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹€à¸à¸“à¸‘à¹Œ *à¸›à¸à¸•à¸´*";
  } else if (bmi < 25) {
    return "âš ï¸ à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹€à¸à¸“à¸‘à¹Œ *à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¹€à¸à¸´à¸™*";
  } else if (bmi < 30) {
    return "ğŸš¨ à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹€à¸à¸“à¸‘à¹Œ *à¸­à¹‰à¸§à¸™à¸£à¸°à¸”à¸±à¸š 1*";
  } else {
    return "ğŸ”¥ à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹€à¸à¸“à¸‘à¹Œ *à¸­à¹‰à¸§à¸™à¸£à¸°à¸”à¸±à¸š 2*";
  }
}


function replyText(replyToken, text) {
  var log = BetterLog.useSpreadsheet();

  var token = PropertiesService.getScriptProperties()
    .getProperty("LINE_CHANNEL_ACCESS_TOKEN");

  log.info("ğŸ“¤ Reply Text: " + JSON.stringify(text));

  var payload = {
    replyToken: replyToken,
    messages: [{
      type: "text",
      text: text
    }]
  };

  var options = {
    method: "post",
    contentType: "application/json",
    headers: {
      Authorization: "Bearer " + token
    },
    payload: JSON.stringify(payload)
  };

  UrlFetchApp.fetch("https://api.line.me/v2/bot/message/reply", options);
}
