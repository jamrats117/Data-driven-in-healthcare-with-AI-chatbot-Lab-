‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ code.gs ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
/**
 * =================================================================
 * üöÄ DIALOGFLOW ES WEBHOOK - CODE.GS (NO-DEPENDENCY VERSION)
 * =================================================================
 * - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (No BetterLog)
 * - ‡πÉ‡∏ä‡πâ Logger ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
 * - ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Å‡∏é "‡∏´‡πâ‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô Sheet" ‡πÉ‡∏ô doPost() ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î
 *
 * üëâ ‡∏î‡∏π Log ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "Executions" ‡πÉ‡∏ô Apps Script Editor
 */

// ----------------------------------------------------------------
// üîß CONFIGURATION
// ----------------------------------------------------------------

const INTENT_PREFIX = "herb";
const CODE_REGEX = /^[hH]\d+/;

// =================================================================
// üèõÔ∏è CORE CACHE-ONLY WRAPPERS
// =================================================================

function getDataCacheOnly_() {
  const cache = CacheService.getScriptCache();
  const cached = cache.get(CACHE_KEY);

  if (cached) {
    try {
      return JSON.parse(cached);
    } catch (e) {
      Logger.log("Error parsing cache: " + e.message);
      return null;
    }
  }
  return null;
}

function findByIndexCacheOnly_(key, value) {
  if (!value) {
    return null;
  }

  const cacheData = getDataCacheOnly_();
  if (!cacheData) {
    return "CACHE_MISS";
  }

  const indexer = INDEX_KEYS[key];
  if (!indexer || !cacheData.index || !cacheData.index[key]) {
      Logger.log("Error: Index key '" + key + "' is not configured or not found in cache structure.");
      return null;
  }

  const normalizedValue = indexer(value);
  return cacheData.index[key][normalizedValue] || null;
}

// =================================================================
// üåê WEBHOOK ENTRY POINT
// =================================================================

function doPost(e) {
  Logger.log("--- doPost Start ---");

  try {
    const request = JSON.parse(e.postData.contents);
    const intentName = request.queryResult.intent.displayName;
    Logger.log("Intent received: " + intentName);

    if (!intentName.startsWith(INTENT_PREFIX)) {
      Logger.log("Intent does not match prefix. Skipping.");
      return ContentService.createTextOutput(JSON.stringify({})).setMimeType(ContentService.MimeType.JSON);
    }

    const query = extractQueryFromContexts_(request.queryResult.outputContexts);

    if (!query) {
      Logger.log("Query not found in any context.");
      // ‚ú® DECORATED RESPONSE
      return createJsonResponse_("ü§î ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏∞");
    }
    Logger.log("Query found: '" + query + "'");

    const searchKey = CODE_REGEX.test(query) ? "code" : "herb";
    Logger.log("Searching with index: '" + searchKey + "'");

    const result = findByIndexCacheOnly_(searchKey, query);

    if (result === "CACHE_MISS") {
      Logger.log("Result: Cache Miss");
       // ‚ú® DECORATED RESPONSE
      return createJsonResponse_("‚è≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 1-2 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞");

    } else if (result) {
      Logger.log("Result: Found item with code: " + result.code);
      const message = formatSuccessMessage_(result);
      return createJsonResponse_(message);

    } else {
      Logger.log("Result: Not Found in system for query: " + query);
       // ‚ú® DECORATED RESPONSE
      return createJsonResponse_(`üôÅ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${query}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πà‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° Admin ‡∏ô‡∏∞‡∏Ñ‡∏∞`);
    }

  } catch (error) {
    Logger.log("!!! CRITICAL ERROR in doPost: " + error.toString() + " Stack: " + error.stack);
     // ‚ú® DECORATED RESPONSE
    return createJsonResponse_("üö® ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏à‡πâ‡∏á Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏∞");
  } finally {
    Logger.log("--- doPost End ---");
  }
}

// =================================================================
// üß∞ HELPER FUNCTIONS
// =================================================================

function extractQueryFromContexts_(outputContexts) {
  if (!outputContexts || outputContexts.length === 0) return null;
  let query = null;
  for (let i = 0; i < outputContexts.length; i++) {
    const params = outputContexts[i].parameters;
    if (params) {
      if (params.herb && String(params.herb).trim()) {
        query = String(params.herb).trim();
        break;
      }
      if (params["herb.original"] && String(params["herb.original"]).trim()) {
        query = String(params["herb.original"]).trim();
      }
    }
  }
  return query;
}

/**
 * ‚ú® NEW: DECORATED SUCCESS MESSAGE FUNCTION
 * Formats the success message with emojis.
 */
function formatSuccessMessage_(item) {
  return `üåø ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£: ${item.herb} (‡∏£‡∏´‡∏±‡∏™: ${item.code})\n` +
         `‚ú® ‡∏™‡∏£‡∏£‡∏û‡∏Ñ‡∏∏‡∏ì: ${item.effect}\n` +
         `üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${item.description}\n` +
         `üìä ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠: ${item.loe}\n` +
         `üìö ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ${item.ref}`;
}

function createJsonResponse_(text) {
  const response = {
    fulfillmentText: text,
    fulfillmentMessages: [{ text: { text: [text] } }]
  };
  return ContentService.createTextOutput(JSON.stringify(response))
                       .setMimeType(ContentService.MimeType.JSON);
}
‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡∏ô flex messaege ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ü‡πâ‡∏≤‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ dialogflow ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
‡∏ú‡∏°‡∏°‡∏µ cache.gs ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥‡∏≠‡∏¢‡πà‡∏∏‡πÅ‡∏•‡πâ‡∏ß
/**
 * üì¶ GENERIC SHEET CACHE TEMPLATE
 * - ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‚Üí CacheService (JSON)
 * - ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ reuse ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
 */

/* ======================================================
 * üîß CONFIG ZONE (‡πÅ‡∏Å‡πâ‡πÅ‡∏Ñ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
 * ====================================================== */

// üîß 1Ô∏è‚É£ ‡∏ä‡∏∑‡πà‡∏≠ cache (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå)
const CACHE_KEY = "DATA_CACHE_V1";

// üîß 2Ô∏è‚É£ ‡∏≠‡∏≤‡∏¢‡∏∏ cache (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
const CACHE_TTL_SECONDS = 6 * 60 * 60; // 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

// üîß 3Ô∏è‚É£ REQUIRED COLUMNS (‡∏ä‡∏∑‡πà‡∏≠ header ‡πÉ‡∏ô sheet)
const REQUIRED_COLUMNS = [
  "code",
  "herb",
  "effect",
  "description",
  "loe",
  "ref"
];

// üîß 4Ô∏è‚É£ INDEX KEYS ‚Üí ‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏î‡πâ‡∏ß‡∏¢ field ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
// key = field ‡πÉ‡∏ô object
// value = function normalize
const INDEX_KEYS = {
  code: v => String(v).toLowerCase(),
  herb: v => String(v).toLowerCase()
};

/* ======================================================
 * üöÄ CACHE CORE
 * ====================================================== */

function getDataCache_(options) {
  options = options || {};
  const forceRefresh = !!options.forceRefresh;

  const cache = CacheService.getScriptCache();
  if (!forceRefresh) {
    const cached = cache.get(CACHE_KEY);
    if (cached) {
      try {
        return JSON.parse(cached);
      } catch (e) {}
    }
  }

  const data = buildCacheFromSheet_();
  cache.put(CACHE_KEY, JSON.stringify(data), CACHE_TTL_SECONDS);
  return data;
}

function refreshDataCache_() {
  return getDataCache_({ forceRefresh: true });
}

function clearDataCache_() {
  CacheService.getScriptCache().remove(CACHE_KEY);
}

/* ======================================================
 * üìÑ BUILD CACHE FROM SHEET
 * ====================================================== */

function buildCacheFromSheet_() {
  const props = PropertiesService.getScriptProperties();
  const sheetId = props.getProperty("SHEET_ID");
  const sheetName = props.getProperty("SHEET_NAME") || "data"; // üîß 5Ô∏è‚É£

  if (!sheetId) throw new Error("Missing SHEET_ID");

  const sh = SpreadsheetApp.openById(sheetId).getSheetByName(sheetName);
  if (!sh) throw new Error("Sheet not found: " + sheetName);

  const values = sh.getDataRange().getValues();
  if (values.length < 2) {
    return { data: [], index: {}, meta: { rows: 0 } };
  }

  const headers = values[0].map(h => normalizeHeader_(h));
  const idx = indexMap_(headers);

  // üîß ‡∏ï‡∏£‡∏ß‡∏à column ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  REQUIRED_COLUMNS.forEach(col => {
    if (idx[col] === undefined) {
      throw new Error("Missing column: " + col);
    }
  });

  const index = {};
  Object.keys(INDEX_KEYS).forEach(k => index[k] = {});

  const data = [];

  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const item = {};

    headers.forEach(h => {
      item[h] = String(row[idx[h]] || "").trim();
    });

    data.push(item);

    // üîß ‡∏™‡∏£‡πâ‡∏≤‡∏á index
    for (const key in INDEX_KEYS) {
      const raw = item[key];
      if (!raw) continue;
      const normalized = INDEX_KEYS[key](raw);
      index[key][normalized] = item;
    }
  }

  return {
    data,
    index,
    meta: {
      rows: data.length,
      sheetName,
      updatedAt: new Date().toISOString(),
      ttlSeconds: CACHE_TTL_SECONDS
    }
  };
}

/* ======================================================
 * üîé SEARCH HELPERS
 * ====================================================== */

function findByIndex_(key, value) {
  if (!value) return null;
  const cache = getDataCache_();
  const normalized = INDEX_KEYS[key](value);
  return cache.index[key]?.[normalized] || null;
}

/* ======================================================
 * üß∞ UTIL
 * ====================================================== */

function indexMap_(headers) {
  const m = {};
  headers.forEach((h, i) => m[h] = i);
  return m;
}

function normalizeHeader_(h) {
  return String(h).trim().toLowerCase().replace(/\s+/g, "_");
}

/* ======================================================
 * üß™ PUBLIC FUNCTIONS
 * ====================================================== */

function buildCache() {
  const data = refreshDataCache_();
  Logger.log(data.meta);
}

function testFind() {
  const item = findByIndex_("herb", "xx");
  Logger.log(item);
}
